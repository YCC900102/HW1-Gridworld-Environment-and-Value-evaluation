<!DOCTYPE html>
<html>
<head>
    <title>HW1-1 Grid Map</title>
    <style>
        table { border-collapse: collapse; }
        td {
            width: 40px; height: 40px;
            border: 1px solid #000;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            cursor: pointer;
        }
        .start { background-color: green; color: white; }
        .end { background-color: red; color: white; }
        .obstacle { background-color: gray; color: white; }
    </style>
</head>

<body>
    <h2>Generate n x n Square</h2>
    <form method="POST">
        <label>Enter a number between 5 and 9: </label>
        <input type="number" name="grid_size" min="5" max="9" required>
        <input type="submit" value="Generate Square">
    </form>

    {% if grid_size %}
        <h3>{{ grid_size }} x {{ grid_size }} Square:</h3>
        <table id="grid">
            {% for i in range(grid_size) %}
            <tr>
                {% for j in range(grid_size) %}
                <td id="cell-{{i}}-{{j}}" onclick="handleClick({{i}}, {{j}})">
                    {{ i * grid_size + j + 1 }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
        <p>剩餘障礙格可設數量：<span id="remaining">{{ grid_size - 2 }}</span></p>
        <br>
        <button onclick="submitMap()">送出地圖設定</button>
    {% endif %}

    <script>
        let phase = 0;  // 0: 起點, 1: 終點, 2: 障礙
        let startSet = false;
        let endSet = false;
        let obstacleLimit = {{ grid_size - 2 if grid_size else 0 }};
        let remaining = obstacleLimit;

        let mapData = {
            start: null,
            end: null,
            obstacles: []
        };

        function handleClick(i, j) {
            const cell = document.getElementById(`cell-${i}-${j}`);

            if (phase === 0) {
                cell.className = "start";
                startSet = true;
                phase = 1;
                mapData.start = [i, j];
            } else if (phase === 1 && !cell.classList.contains("start")) {
                cell.className = "end";
                endSet = true;
                phase = 2;
                mapData.end = [i, j];
            } else if (phase === 2) {
                const key = `${i},${j}`;
                if (cell.classList.contains("obstacle")) {
                    cell.classList.remove("obstacle");
                    remaining++;
                    mapData.obstacles = mapData.obstacles.filter(item => item !== key);
                } else if (!cell.classList.contains("start") && !cell.classList.contains("end")) {
                    if (remaining > 0) {
                        cell.classList.add("obstacle");
                        remaining--;
                        mapData.obstacles.push(key);
                    } else {
                        alert("已達障礙格數量上限！");
                    }
                }
                document.getElementById("remaining").innerText = remaining;
            }
        }

        function submitMap() {
            if (!mapData.start || !mapData.end) {
                alert("請先設定起點與終點！");
                return;
            }

            const formattedObstacles = mapData.obstacles.map(item => item.split(',').map(Number));
            const payload = {
                start: mapData.start,
                end: mapData.end,
                obstacles: formattedObstacles,
                size: {{ grid_size }}
            };

            fetch("/save_map", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            });
        }
    </script>
</body>
</html>
